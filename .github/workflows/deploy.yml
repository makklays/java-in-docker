name: Spring Boot CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
        uses: actions/checkout@v3

      - name: â˜• Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin' # â† ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð°Ð²Ð¸Ð¼ Temurin JDK

      - name: ðŸ§ª Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Maven
        run: mvn clean verify

      - name: ðŸ“¦ Ð¡Ð±Ð¾Ñ€ÐºÐ° JAR-Ñ„Ð°Ð¹Ð»Ð°
        run: mvn package -DskipTests

      - name: ðŸ“¤ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ JAR ÐºÐ°Ðº Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚
        uses: actions/upload-artifact@v3
        with:
          name: spring-boot-app
          path: target/*.jar

      - name: ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ (Ð¿Ð¾ SSH)
        if: success()
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "target/*.jar"
          target: "/home/youruser/app"

      - name: ðŸ” ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Spring Boot Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
        if: success()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            pkill -f 'java.*app.jar' || true
            nohup java -jar /home/youruser/app/*.jar > log.txt 2>&1 &